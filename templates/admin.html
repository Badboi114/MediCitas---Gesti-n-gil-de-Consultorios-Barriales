<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | MediCitas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Forzar que el sidebar siempre mantenga su ancho */
        #sidebar {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            bottom: 0 !important;
            width: 16rem !important;
            min-width: 16rem !important;
            max-width: 16rem !important;
            flex-shrink: 0 !important;
            z-index: 1000 !important;
            overflow-x: visible !important;
        }
        
        /* Forzar que todos los textos del sidebar sean visibles */
        #sidebar * {
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #sidebar p,
        #sidebar span,
        #sidebar button {
            white-space: nowrap !important;
        }
        
        /* Ajustar el contenido principal para que no se superponga con el sidebar */
        main {
            margin-left: 16rem !important;
        }
        
        .nav-item.active { 
            background-color: #374151; 
            border-left: 4px solid #10b981; 
            padding-left: calc(0.75rem - 4px);
        }
        .fade-in { 
            animation: fadeIn 0.3s ease-in-out; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .section-content {
            display: none;
        }
        .section-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" style="width: 16rem; min-width: 16rem; max-width: 16rem; flex-shrink: 0;" class="bg-slate-900 text-white flex flex-col shadow-2xl z-20">
        <div class="p-6 text-2xl font-bold border-b border-slate-800 flex items-center gap-2">
            <span class="bg-emerald-500 w-2 h-8 rounded-full"></span> 
            <span>Admin<span class="text-emerald-400">Panel</span></span>
        </div>
        
        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <p class="px-3 text-xs font-bold text-slate-500 uppercase mb-2 mt-2">General</p>
            <button onclick="showSection('dashboard')" class="nav-item w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3 active">
                Dashboard
            </button>
            <button onclick="showSection('config')" class="nav-item w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3">
                Configuraci√≥n Global
            </button>

            <p class="px-3 text-xs font-bold text-slate-500 uppercase mb-2 mt-6">Gesti√≥n</p>
            <button onclick="showSection('doctores')" class="nav-item w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3">
                Elementos (Doctores)
            </button>
            <button onclick="showSection('pacientes')" class="nav-item w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3">
                Pacientes & Historia
            </button>
            <button onclick="showSection('citas')" class="nav-item w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3">
                Auditor√≠a de Citas
            </button>
            <button onclick="showSection('papelera')" class="nav-item w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3">
                Papelera (Inactivos)
            </button>
            
            <p class="px-3 text-xs font-bold text-slate-500 uppercase mb-2 mt-6">Cuenta</p>
            <button onclick="showSection('perfil')" class="nav-item w-full text-left p-3 rounded hover:bg-slate-800 transition flex items-center gap-3">
                Mi Perfil / Seguridad
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <a href="/medicitas" class="block mb-2 text-center text-xs bg-emerald-600 hover:bg-emerald-700 py-2 rounded text-white font-bold transition">
                Abrir Agenda P√∫blica ‚Üó
            </a>
            <a href="/logout" class="text-sm text-red-400 hover:text-red-300 flex items-center gap-2 justify-center font-bold">
                &larr; Cerrar Sesi√≥n
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto bg-slate-100 p-8 relative">
        
        <!-- SECCI√ìN: Dashboard -->
        <section id="sec-dashboard" class="section-content active fade-in space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">M√≥dulo de Gesti√≥n Administrativa</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <div class="text-slate-400 text-xs uppercase font-bold">Total Citas</div>
                    <div class="text-4xl font-bold mt-2">{{ stats.total }}</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500">
                    <div class="text-slate-400 text-xs uppercase font-bold">Doctores Activos</div>
                    <div class="text-4xl font-bold mt-2">{{ stats.docs }}</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                    <div class="text-slate-400 text-xs uppercase font-bold">Pacientes Registrados</div>
                    <div class="text-4xl font-bold mt-2">{{ stats.pacs }}</div>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN: Configuraci√≥n Global -->
        <section id="sec-config" class="section-content fade-in max-w-2xl">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Configuraci√≥n Global</h2>
            <div class="bg-white p-8 rounded-xl shadow-sm">
                <form action="/admin/config" method="POST" class="space-y-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">Hora Apertura Consultorio</label>
                            <input type="time" name="hora_apertura" value="{{ config.hora_apertura }}" 
                                   class="w-full p-3 border rounded-lg bg-slate-50 font-mono text-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">Hora Cierre Consultorio</label>
                            <input type="time" name="hora_cierre" value="{{ config.hora_cierre }}" 
                                   class="w-full p-3 border rounded-lg bg-slate-50 font-mono text-lg">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-3">D√≠as Laborales (Marque los d√≠as que trabajan)</label>
                        <div class="flex gap-3 flex-wrap">
                            {% for dia, label in [('1','Lunes'), ('2','Martes'), ('3','Mi√©rcoles'), ('4','Jueves'), ('5','Viernes'), ('6','S√°bado'), ('0','Domingo')] %}
                            <label class="inline-flex items-center bg-slate-50 px-4 py-3 rounded-lg border-2 border-slate-200 cursor-pointer hover:bg-emerald-50 hover:border-emerald-300 transition">
                                <input type="checkbox" name="dias" value="{{ dia }}" class="form-checkbox text-emerald-500 rounded h-5 w-5" 
                                {% if dia in config.dias_laborales %}checked{% endif %}>
                                <span class="ml-2 font-bold text-sm">{{ label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <p class="text-xs text-amber-600 mt-2">* Los d√≠as no marcados estar√°n ocultos en el calendario p√∫blico</p>
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-900 font-bold shadow-lg transform active:scale-95 transition">
                        Guardar Cambios Param√©tricos
                    </button>
                    <p class="text-xs text-slate-400 text-center">
                        * Esto ajusta autom√°ticamente los l√≠mites visuales del calendario p√∫blico.
                    </p>
                </form>
            </div>
        </section>

        <!-- SECCI√ìN: Elementos (Doctores) -->
        <section id="sec-doctores" class="section-content fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Gesti√≥n de Elementos (Personal M√©dico)</h2>
                <button onclick="abrirModalDoctor()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow-md transition">
                    + Nuevo Especialista
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold">
                        <tr>
                            <th class="p-4 border-b">Doctor</th>
                            <th class="p-4 border-b">Contacto</th>
                            <th class="p-4 border-b">Horario</th>
                            <th class="p-4 border-b text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-sm">
                        {% for doc in doctores %}
                        <tr class="hover:bg-slate-50 group">
                            <td class="p-4">
                                <div class="font-bold text-slate-700">{{ doc.nombre }}</div>
                                <div class="text-xs text-slate-400">{{ doc.especialidad }}</div>
                            </td>
                            <td class="p-4">
                                <div class="text-xs">CI: {{ doc.ci }}</div>
                                <div class="text-xs">Tel: {{ doc.telefono }}</div>
                                <div class="text-xs text-blue-500">{{ doc.correo }}</div>
                            </td>
                            <td class="p-4 text-xs">
                                {% if doc.hora_entrada %}
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Personal: {{ doc.hora_entrada }} - {{ doc.hora_salida }}</span>
                                {% else %}
                                    <span class="bg-slate-100 text-slate-500 px-2 py-1 rounded">Usa Horario Global</span>
                                {% endif %}
                                <div class="mt-1 text-slate-400">{{ doc.duracion_cita }} min/cita</div>
                            </td>
                            <td class="p-4 text-right space-x-2">
                                <button onclick='editarDoctor("{{doc.id}}", "{{doc.nombre}}", "{{doc.especialidad}}", "{{doc.duracion_cita}}", "{{doc.ci}}", "{{doc.telefono}}", "{{doc.correo}}", "{{doc.hora_entrada}}", "{{doc.hora_salida}}")' 
                                        class="text-blue-500 hover:underline font-semibold">Editar</button>
                                <button onclick="borrarDoctor('{{doc.id}}')" 
                                        class="text-red-500 hover:underline font-semibold">Eliminar</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not doctores %}
                <p class="p-8 text-center text-slate-400 italic">No hay doctores registrados. Crea uno para empezar.</p>
                {% endif %}
            </div>
        </section>

        <!-- SECCI√ìN: Pacientes -->
        <section id="sec-pacientes" class="section-content fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Directorio de Pacientes e Historiales Cl√≠nicos</h2>
                <button onclick="document.getElementById('modalNuevoPaciente').classList.remove('hidden')" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-md transition">
                    + Nuevo Paciente
                </button>
            </div>
            
            <!-- Buscador de Pacientes -->
            <div class="mb-4 bg-white p-4 rounded-lg shadow-sm">
                <div class="flex gap-3 items-center">
                    <div class="flex-1 relative">
                        <input type="text" 
                               id="searchPaciente" 
                               placeholder="Buscar paciente por CI (Ejemplo: 9878542)" 
                               class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition font-mono text-lg"
                               oninput="filtrarPacientes()">
                        <span id="resultadoCount" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 font-bold"></span>
                    </div>
                    <button onclick="limpiarBusqueda()" 
                            class="px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg font-bold transition">
                        Limpiar
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold">
                        <tr>
                            <th class="p-4">CI</th>
                            <th class="p-4">Nombre</th>
                            <th class="p-4">Contacto</th>
                            <th class="p-4">Historial Resumido</th>
                            <th class="p-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="tablaPacientes">
                        {% for p in pacientes %}
                        <tr class="hover:bg-slate-50 fila-paciente" data-ci="{{ p.ci }}">
                            <td class="p-4 font-mono font-bold">{{ p.ci }}</td>
                            <td class="p-4 font-bold">{{ p.nombre }}</td>
                            <td class="p-4 text-slate-500">+591 {{ p.telefono }}</td>
                            <td class="p-4">
                                {% if p.alergias and p.alergias != 'Ninguna conocida' %}
                                <span class="text-red-500 text-xs block">{{ p.alergias }}</span>
                                {% endif %}
                                {% if p.cirugias and p.cirugias != 'Ninguna' %}
                                <span class="text-blue-500 text-xs block">{{ p.cirugias }}</span>
                                {% endif %}
                                {% if p.notas_medicas %}
                                <span class="text-slate-400 text-xs italic truncate block max-w-xs">{{ p.notas_medicas }}</span>
                                {% endif %}
                            </td>
                            <td class="p-4 text-right space-x-2">
                                <button onclick='verDetallePaciente({{ p.id }}, "{{ p.ci }}", "{{ p.nombre }}", "{{ p.telefono }}", "{{ p.alergias|replace('"', '\\"') }}", "{{ p.cirugias|replace('"', '\\"') }}", "{{ p.notas_medicas|replace('"', '\\"') }}")' 
                                        class="text-emerald-500 hover:underline font-semibold">Ver</button>
                                <button onclick='editarPaciente({{ p.id }}, "{{ p.ci }}", "{{ p.nombre }}", "{{ p.telefono }}", "{{ p.alergias|replace('"', '\\"') }}", "{{ p.cirugias|replace('"', '\\"') }}", "{{ p.notas_medicas|replace('"', '\\"') }}")' 
                                        class="text-blue-500 hover:underline font-semibold">Editar</button>
                                <button onclick="borrarPaciente({{ p.id }})" 
                                        class="text-red-500 hover:underline font-semibold">Eliminar</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not pacientes %}
                <p class="p-8 text-center text-slate-400 italic">No hay pacientes registrados todav√≠a.</p>
                {% endif %}
            </div>
        </section>

        <!-- SECCI√ìN: Auditor√≠a de Citas -->
        <section id="sec-citas" class="section-content fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Auditor√≠a de Citas (Vista Tabular)</h2>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-bold">
                        <tr>
                            <th class="p-4">ID</th>
                            <th class="p-4">Fecha/Hora</th>
                            <th class="p-4">Paciente</th>
                            <th class="p-4">Doctor</th>
                            <th class="p-4">Motivo</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for c in citas %}
                        <tr class="hover:bg-slate-50">
                            <td class="p-4 font-mono text-xs">#{{ c.id }}</td>
                            <td class="p-4">
                                <div class="font-bold">{{ c.fecha_inicio.strftime('%d/%m/%Y') }}</div>
                                <div class="text-xs text-slate-400">{{ c.fecha_inicio.strftime('%H:%M') }} - {{ c.fecha_fin.strftime('%H:%M') }}</div>
                            </td>
                            <td class="p-4">
                                {% if c.paciente %}
                                <div class="font-medium">{{ c.paciente.nombre }}</div>
                                <div class="text-xs text-slate-400">CI: {{ c.paciente.ci }}</div>
                                {% else %}
                                <span class="text-slate-400 text-xs">Sin Datos</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">
                                    {{ c.doctor.nombre }}
                                </span>
                            </td>
                            <td class="p-4 text-slate-500 italic truncate max-w-xs">{{ c.motivo }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not citas %}
                <p class="p-8 text-center text-slate-400 italic">No hay citas registradas en el sistema.</p>
                {% endif %}
            </div>
        </section>

        <!-- SECCI√ìN: Papelera (Elementos Inactivos) -->
        <section id="sec-papelera" class="section-content fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Papelera - Registros Inactivos</h2>
            
            <!-- Doctores Inactivos -->
            <div class="mb-8">
                <h3 class="text-lg font-bold text-slate-700 mb-4">Doctores Dados de Baja</h3>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-red-50 text-xs uppercase text-red-700 font-bold">
                            <tr>
                                <th class="p-4">Doctor</th>
                                <th class="p-4">Especialidad</th>
                                <th class="p-4">Contacto</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {% for d in doctores_inactivos %}
                            <tr class="hover:bg-slate-50 opacity-60">
                                <td class="p-4 font-bold text-slate-600">{{ d.nombre }}</td>
                                <td class="p-4 text-slate-500">{{ d.especialidad }}</td>
                                <td class="p-4 text-xs text-slate-400">
                                    {% if d.telefono %}{{ d.telefono }}<br>{% endif %}
                                    {% if d.correo %}{{ d.correo }}{% endif %}
                                </td>
                                <td class="p-4 text-right">
                                    <button onclick="restaurarDoctor({{ d.id }})" 
                                            class="text-green-600 hover:underline font-semibold">
                                        ‚Üª Restaurar
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="p-8 text-center text-slate-400 italic">No hay doctores inactivos.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pacientes Inactivos -->
            <div>
                <h3 class="text-lg font-bold text-slate-700 mb-4">Pacientes Dados de Baja</h3>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-red-50 text-xs uppercase text-red-700 font-bold">
                            <tr>
                                <th class="p-4">CI</th>
                                <th class="p-4">Nombre</th>
                                <th class="p-4">Contacto</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {% for p in pacientes_inactivos %}
                            <tr class="hover:bg-slate-50 opacity-60">
                                <td class="p-4 font-mono font-bold text-slate-600">{{ p.ci }}</td>
                                <td class="p-4 font-bold text-slate-600">{{ p.nombre }}</td>
                                <td class="p-4 text-slate-500">+591 {{ p.telefono }}</td>
                                <td class="p-4 text-right">
                                    <button onclick="restaurarPaciente({{ p.id }})" 
                                            class="text-green-600 hover:underline font-semibold">
                                        ‚Üª Restaurar
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="p-8 text-center text-slate-400 italic">No hay pacientes inactivos.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Citas Eliminadas -->
            <div class="mt-8">
                <h3 class="text-lg font-bold text-slate-700 mb-4">Citas Eliminadas</h3>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-orange-50 text-xs uppercase text-orange-700 font-bold">
                            <tr>
                                <th class="p-4">ID</th>
                                <th class="p-4">Doctor</th>
                                <th class="p-4">Paciente</th>
                                <th class="p-4">Fecha y Hora</th>
                                <th class="p-4">Motivo</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {% for c in citas_inactivas %}
                            <tr class="hover:bg-slate-50 opacity-60">
                                <td class="p-4 font-mono text-slate-600">#{{ c.id }}</td>
                                <td class="p-4 text-slate-600">
                                    <div class="font-bold">{{ c.doctor.nombre }}</div>
                                    <div class="text-xs text-slate-400">{{ c.doctor.especialidad }}</div>
                                </td>
                                <td class="p-4 text-slate-600">
                                    <div class="font-bold">{{ c.paciente.nombre }}</div>
                                    <div class="text-xs text-slate-400">CI: {{ c.paciente.ci }}</div>
                                </td>
                                <td class="p-4 text-slate-600">
                                    <div class="font-semibold">{{ c.fecha_inicio.strftime('%d/%m/%Y') }}</div>
                                    <div class="text-xs text-slate-400">{{ c.fecha_inicio.strftime('%H:%M') }} - {{ c.fecha_fin.strftime('%H:%M') }}</div>
                                </td>
                                <td class="p-4 text-slate-500">{{ c.motivo or 'Sin especificar' }}</td>
                                <td class="p-4 text-right">
                                    <button onclick="restaurarCita({{ c.id }})" 
                                            class="text-green-600 hover:underline font-semibold">
                                        ‚Üª Restaurar
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="p-8 text-center text-slate-400 italic">No hay citas eliminadas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECCI√ìN: Mi Perfil / Seguridad -->
        <section id="sec-perfil" class="section-content fade-in max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Gestionar Credenciales de Administrador</h2>
            <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-emerald-500">
                <div class="flex items-center justify-center mb-8">
                    <div class="bg-gradient-to-br from-emerald-100 to-emerald-200 p-6 rounded-full shadow-inner">
                        <svg class="w-16 h-16 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
                    <p class="text-sm text-blue-700">
                        <strong>Nota de Seguridad:</strong> Cambie las credenciales por defecto. Esta informaci√≥n permite acceso total al sistema.
                    </p>
                </div>

                <form id="formPerfil" action="/admin/perfil" method="POST" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Nombre de Usuario</label>
                        <input type="text" name="username" value="{{ admin.username }}" required
                               class="w-full p-3 border-2 border-slate-200 rounded-lg bg-slate-50 outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition font-semibold">
                        <p class="text-xs text-slate-400 mt-1">Este ser√° tu nuevo nombre de usuario para iniciar sesi√≥n</p>
                    </div>

                    <hr class="border-slate-200">
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <p class="text-sm text-blue-700 font-bold">
                            üîê Para cambiar cualquier credencial, debe ingresar su contrase√±a actual
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Contrase√±a Actual <span class="text-red-500">*</span></label>
                        <input type="password" id="current_password" name="current_password" required
                               autocomplete="current-password"
                               value=""
                               class="w-full p-3 border-2 border-red-200 rounded-lg bg-red-50 outline-none focus:border-red-500 focus:ring-4 focus:ring-red-100 transition font-mono"
                               placeholder="Ingrese su contrase√±a actual para continuar">
                        <p class="text-xs text-red-500 mt-1 hidden" id="errorCurrentPassword">‚ö†Ô∏è La contrase√±a actual no coincide</p>
                    </div>

                    <hr class="border-slate-200">
                    <p class="text-sm font-bold text-slate-700">Cambiar Contrase√±a (Opcional)</p>
                    <p class="text-xs text-slate-500">Deje estos campos vac√≠os si NO desea cambiar la contrase√±a</p>

                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Nueva Contrase√±a</label>
                        <input type="password" id="new_password" name="password" minlength="4"
                               autocomplete="new-password"
                               value=""
                               class="w-full p-3 border-2 border-slate-200 rounded-lg bg-slate-50 outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition font-mono"
                               placeholder="Dejar vac√≠o para mantener la contrase√±a actual">
                        <p class="text-xs text-slate-400 mt-1">M√≠nimo 4 caracteres si desea cambiarla</p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Confirmar Nueva Contrase√±a</label>
                        <input type="password" id="confirm_password" minlength="4"
                               autocomplete="new-password"
                               value=""
                               class="w-full p-3 border-2 border-slate-200 rounded-lg bg-slate-50 outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-100 transition font-mono"
                               placeholder="Repetir la nueva contrase√±a">
                        <p class="text-xs text-red-500 mt-1 hidden" id="errorConfirmPassword">‚ö†Ô∏è Las contrase√±as no coinciden</p>
                    </div>
                    
                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded">
                        <p class="text-sm text-amber-700">
                            <strong>Importante:</strong> Aseg√∫rese de recordar las nuevas credenciales. No hay recuperaci√≥n autom√°tica.
                        </p>
                    </div>

                    <button type="submit" class="w-full py-4 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-lg hover:from-emerald-700 hover:to-emerald-800 font-bold shadow-lg hover:shadow-xl transform active:scale-95 transition text-lg">
                        Actualizar Credenciales
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <p class="text-xs text-slate-400">Usuario actual: <span class="font-mono font-bold text-emerald-600">{{ admin.username }}</span></p>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal para Doctores -->
    <div id="modalDoctor" class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 transform transition-all">
            <h3 id="modalDocTitle" class="text-lg font-bold text-slate-800 mb-4">Nuevo Especialista</h3>
            <form id="formDoctor" class="space-y-4">
                <input type="hidden" name="doc_id" id="docId">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nombre y Apellido</label>
                    <input type="text" name="nombre" id="docNombre" required 
                           class="w-full border rounded p-2 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Especialidad</label>
                    <input type="text" name="especialidad" id="docEspecialidad" required 
                           class="w-full border rounded p-2 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" 
                           placeholder="Ej: Dentista, Pediatra, Dermat√≥logo...">
                </div>
                
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">CI</label>
                        <input type="text" name="ci" id="docCI" required 
                               class="w-full border rounded p-2 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" 
                               placeholder="C√©dula">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Tel√©fono</label>
                        <input type="text" name="telefono" id="docTel" required 
                               class="w-full border rounded p-2 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" 
                               placeholder="Celular">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Duraci√≥n (min)</label>
                        <input type="number" name="duracion" id="docDuracion" required value="30" min="15" max="120" step="5"
                               class="w-full border rounded p-2 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Correo Electr√≥nico</label>
                    <input type="email" name="correo" id="docCorreo" required 
                           class="w-full border rounded p-2 outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200" 
                           placeholder="correo@ejemplo.com">
                </div>
                
                <hr class="my-2">
                <p class="text-xs font-bold text-slate-500 mb-2">Horario Personalizado (Dejar vac√≠o para usar horario global)</p>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Hora Entrada</label>
                        <input type="time" name="hora_entrada" id="docEntrada" 
                               class="w-full border rounded p-2 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Hora Salida</label>
                        <input type="time" name="hora_salida" id="docSalida" 
                               class="w-full border rounded p-2 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                </div>
                <p class="text-xs text-amber-600 mt-1">Si se define, este horario sobrescribe el global solo para este doctor</p>
                
                <div class="flex gap-2 pt-4">
                    <button type="button" onclick="cerrarModalDoctor()" 
                            class="flex-1 py-2 bg-slate-100 rounded text-slate-600 font-bold hover:bg-slate-200 transition">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="flex-1 py-2 bg-emerald-500 rounded text-white font-bold hover:bg-emerald-600 transition">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo Paciente -->
    <div id="modalNuevoPaciente" class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-[400px]">
            <h3 class="text-lg font-bold mb-4 text-slate-800">Registrar Nuevo Paciente</h3>
            <form id="formNuevoPaciente" class="space-y-3">
                <input type="text" name="ci" required placeholder="C√©dula de Identidad" 
                       class="w-full border rounded p-2 outline-none focus:border-blue-500">
                <input type="text" name="nombre" required placeholder="Nombre Completo" 
                       class="w-full border rounded p-2 outline-none focus:border-blue-500">
                <input type="text" name="telefono" required placeholder="Tel√©fono (8 d√≠gitos)" 
                       class="w-full border rounded p-2 outline-none focus:border-blue-500">
                <textarea name="alergias" placeholder="Alergias conocidas" 
                          class="w-full border rounded p-2 h-16 outline-none focus:border-blue-500"></textarea>
                <textarea name="cirugias" placeholder="Cirug√≠as previas" 
                          class="w-full border rounded p-2 h-16 outline-none focus:border-blue-500"></textarea>
                <textarea name="notas" placeholder="Notas m√©dicas adicionales" 
                          class="w-full border rounded p-2 h-16 outline-none focus:border-blue-500"></textarea>
                <div class="flex gap-2">
                    <button type="button" onclick="document.getElementById('modalNuevoPaciente').classList.add('hidden')" 
                            class="flex-1 py-2 bg-slate-100 rounded font-bold hover:bg-slate-200">Cancelar</button>
                    <button type="submit" 
                            class="flex-1 py-2 bg-blue-500 text-white rounded font-bold hover:bg-blue-600">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Pacientes - Ver Detalle -->
    <div id="modalDetallePaciente" class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-[500px] max-h-[90vh] overflow-y-auto transform transition-all">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-bold text-slate-800">Expediente del Paciente</h3>
                <button onclick="cerrarModalDetallePaciente()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-lg">
                    <label class="text-xs font-bold text-slate-500 uppercase">Carnet de Identidad</label>
                    <p id="detalleCi" class="text-lg font-mono font-bold text-slate-800">-</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg">
                    <label class="text-xs font-bold text-slate-500 uppercase">Nombre Completo</label>
                    <p id="detalleNombre" class="text-lg font-bold text-slate-800">-</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg">
                    <label class="text-xs font-bold text-slate-500 uppercase">Tel√©fono/Celular</label>
                    <p id="detalleTelefono" class="text-lg text-slate-700">-</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                    <label class="text-xs font-bold text-red-600 uppercase">Alergias</label>
                    <p id="detalleAlergias" class="text-sm text-red-700 mt-1">-</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <label class="text-xs font-bold text-blue-600 uppercase">Cirug√≠as Previas</label>
                    <p id="detalleCirugias" class="text-sm text-blue-700 mt-1">-</p>
                </div>
                <div class="bg-slate-50 p-4 rounded-lg">
                    <label class="text-xs font-bold text-slate-500 uppercase">Notas M√©dicas</label>
                    <p id="detalleNotas" class="text-sm text-slate-700 mt-1 whitespace-pre-wrap">-</p>
                </div>
            </div>
            <div class="mt-6 flex gap-2">
                <button onclick="cerrarModalDetallePaciente()" 
                        class="flex-1 py-2 bg-slate-100 rounded text-slate-600 font-bold hover:bg-slate-200 transition">
                    Cerrar
                </button>
                <button onclick="editarDesdeDetalle()" 
                        class="flex-1 py-2 bg-blue-500 rounded text-white font-bold hover:bg-blue-600 transition">
                    Editar Expediente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Pacientes - Editar -->
    <div id="modalPaciente" class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-[500px] max-h-[90vh] overflow-y-auto transform transition-all">
            <h3 id="modalPacTitle" class="text-lg font-bold text-slate-800 mb-4">Editar Paciente</h3>
            <form id="formPaciente" class="space-y-4">
                <input type="hidden" name="pac_id" id="pacId">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Carnet de Identidad (CI)</label>
                    <input type="text" name="ci" id="pacCi" required pattern="\d{5,10}" 
                           class="w-full border rounded p-2 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 font-mono"
                           placeholder="Ej: 12345678">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nombre Completo</label>
                    <input type="text" name="nombre" id="pacNombre" required 
                           class="w-full border rounded p-2 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Tel√©fono/Celular</label>
                    <input type="tel" name="telefono" id="pacTelefono" required pattern="[67]\d{7}" 
                           class="w-full border rounded p-2 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                           placeholder="Ej: 75644345">
                </div>
                <div>
                    <label class="block text-xs font-bold text-red-500 mb-1">Alergias Conocidas</label>
                    <textarea name="alergias" id="pacAlergias" rows="2" 
                              class="w-full border rounded p-2 outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200"
                              placeholder="Ej: Penicilina, Polen..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-blue-500 mb-1">Cirug√≠as Previas</label>
                    <textarea name="cirugias" id="pacCirugias" rows="2" 
                              class="w-full border rounded p-2 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                              placeholder="Ej: Apendicectom√≠a 2020..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Notas M√©dicas</label>
                    <textarea name="notas" id="pacNotas" rows="3" 
                              class="w-full border rounded p-2 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                              placeholder="Observaciones generales..."></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="cerrarModalPaciente()" 
                            class="flex-1 py-2 bg-slate-100 rounded text-slate-600 font-bold hover:bg-slate-200 transition">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="flex-1 py-2 bg-purple-500 rounded text-white font-bold hover:bg-purple-600 transition">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // NAVEGACI√ìN TIPO SPA
        function showSection(id) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section-content').forEach(el => {
                el.classList.remove('active');
            });
            // Quitar clase active de todos los botones
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar secci√≥n seleccionada
            const section = document.getElementById('sec-' + id);
            if(section) {
                section.classList.add('active');
            }
            
            // Activar bot√≥n del men√∫
            const btn = document.querySelector(`button[onclick="showSection('${id}')"]`);
            if(btn) {
                btn.classList.add('active');
            }
            
            // LIMPIAR campos de contrase√±a cuando se abre la secci√≥n de perfil
            if(id === 'perfil') {
                setTimeout(() => {
                    const currentPwd = document.getElementById('current_password');
                    const newPwd = document.getElementById('new_password');
                    const confirmPwd = document.getElementById('confirm_password');
                    
                    if(currentPwd) currentPwd.value = '';
                    if(newPwd) newPwd.value = '';
                    if(confirmPwd) confirmPwd.value = '';
                    
                    // Ocultar mensajes de error
                    document.getElementById('errorCurrentPassword')?.classList.add('hidden');
                    document.getElementById('errorConfirmPassword')?.classList.add('hidden');
                }, 50);
            }
        }

        // GESTI√ìN DOCTORES
        function abrirModalDoctor() {
            document.getElementById('docId').value = '';
            document.getElementById('docNombre').value = '';
            document.getElementById('docEspecialidad').value = '';
            document.getElementById('docDuracion').value = '30';
            document.getElementById('docCI').value = '';
            document.getElementById('docTel').value = '';
            document.getElementById('docCorreo').value = '';
            document.getElementById('docEntrada').value = '';
            document.getElementById('docSalida').value = '';
            document.getElementById('modalDocTitle').innerText = "Nuevo Especialista";
            document.getElementById('modalDoctor').classList.remove('hidden');
        }

        function cerrarModalDoctor() {
            document.getElementById('modalDoctor').classList.add('hidden');
        }

        function editarDoctor(id, nombre, esp, dur, ci, tel, correo, entrada, salida) {
            document.getElementById('docId').value = id;
            document.getElementById('docNombre').value = nombre;
            document.getElementById('docEspecialidad').value = esp;
            document.getElementById('docDuracion').value = dur;
            document.getElementById('docCI').value = ci;
            document.getElementById('docTel').value = tel;
            document.getElementById('docCorreo').value = correo;
            document.getElementById('docEntrada').value = (entrada && entrada !== 'None') ? entrada : '';
            document.getElementById('docSalida').value = (salida && salida !== 'None') ? salida : '';
            document.getElementById('modalDocTitle').innerText = "Editar Especialista";
            document.getElementById('modalDoctor').classList.remove('hidden');
        }

        // Manejador del formulario de doctor
        document.getElementById('formDoctor').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/admin/doctor/guardar', {
                    method: 'POST',
                    body: formData
                });
                
                if(response.ok) {
                    localStorage.setItem('lastSection', 'doctores');
                    localStorage.setItem('justSaved', 'true');
                    await Swal.fire({
                        icon: 'success',
                        title: 'Guardado',
                        text: 'Doctor guardado exitosamente',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    location.reload();
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo guardar el doctor'
                    });
                }
            } catch(error) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurri√≥ un error al guardar'
                });
            }
        });

        async function borrarDoctor(id) {
            const res = await Swal.fire({
                title: '¬øEliminar Doctor?',
                text: "Esta acci√≥n no se puede deshacer. Se verificar√° si tiene citas pendientes.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            });
            
            if(res.isConfirmed) {
                try {
                    const fd = new FormData();
                    fd.append('doc_id', id);
                    const response = await fetch('/admin/doctor/borrar', { 
                        method: 'POST', 
                        body: fd 
                    });
                    
                    const data = await response.json();
                    
                    if(response.ok) {
                        localStorage.setItem('lastSection', 'doctores');
                        localStorage.setItem('justSaved', 'true');
                        await Swal.fire({
                            icon: 'success',
                            title: 'Eliminado',
                            text: 'El doctor ha sido eliminado correctamente',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        location.reload();
                    } else {
                        await Swal.fire({
                            icon: 'error',
                            title: 'No se pudo eliminar',
                            text: data.msg || 'El doctor tiene citas pendientes'
                        });
                    }
                } catch(error) {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ocurri√≥ un error al intentar eliminar'
                    });
                }
            }
        }

        // GESTI√ìN PACIENTES
        let pacienteActualId = null;

        function verDetallePaciente(id, ci, nombre, telefono, alergias, cirugias, notas) {
            pacienteActualId = id;
            document.getElementById('detalleCi').innerText = ci;
            document.getElementById('detalleNombre').innerText = nombre;
            document.getElementById('detalleTelefono').innerText = '+591 ' + telefono;
            document.getElementById('detalleAlergias').innerText = alergias || 'Ninguna conocida';
            document.getElementById('detalleCirugias').innerText = cirugias || 'Ninguna';
            document.getElementById('detalleNotas').innerText = notas || 'Sin notas adicionales';
            document.getElementById('modalDetallePaciente').classList.remove('hidden');
        }

        function cerrarModalDetallePaciente() {
            document.getElementById('modalDetallePaciente').classList.add('hidden');
        }

        function editarDesdeDetalle() {
            const ci = document.getElementById('detalleCi').innerText;
            const nombre = document.getElementById('detalleNombre').innerText;
            const telefono = document.getElementById('detalleTelefono').innerText.replace('+591 ', '');
            const alergias = document.getElementById('detalleAlergias').innerText;
            const cirugias = document.getElementById('detalleCirugias').innerText;
            const notas = document.getElementById('detalleNotas').innerText;
            
            cerrarModalDetallePaciente();
            editarPaciente(pacienteActualId, ci, nombre, telefono, alergias, cirugias, notas);
        }

        function editarPaciente(id, ci, nombre, telefono, alergias, cirugias, notas) {
            document.getElementById('pacId').value = id;
            document.getElementById('pacCi').value = ci;
            document.getElementById('pacNombre').value = nombre;
            document.getElementById('pacTelefono').value = telefono;
            document.getElementById('pacAlergias').value = alergias === 'Ninguna conocida' ? '' : alergias;
            document.getElementById('pacCirugias').value = cirugias === 'Ninguna' ? '' : cirugias;
            document.getElementById('pacNotas').value = notas === 'Sin notas adicionales' ? '' : notas;
            document.getElementById('modalPacTitle').innerText = "Editar Paciente";
            document.getElementById('modalPaciente').classList.remove('hidden');
        }

        function cerrarModalPaciente() {
            document.getElementById('modalPaciente').classList.add('hidden');
        }

        // Manejador del formulario de editar paciente
        document.getElementById('formPaciente').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/admin/paciente/guardar', {
                    method: 'POST',
                    body: formData
                });
                
                if(response.ok) {
                    localStorage.setItem('lastSection', 'pacientes');
                    localStorage.setItem('justSaved', 'true');
                    await Swal.fire({
                        icon: 'success',
                        title: 'Actualizado',
                        text: 'Paciente actualizado exitosamente',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    location.reload();
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo actualizar el paciente'
                    });
                }
            } catch(error) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurri√≥ un error al actualizar'
                });
            }
        });

        // Manejador del formulario de nuevo paciente
        document.getElementById('formNuevoPaciente').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/admin/paciente/crear', {
                    method: 'POST',
                    body: formData
                });
                
                if(response.ok) {
                    localStorage.setItem('lastSection', 'pacientes');
                    localStorage.setItem('justSaved', 'true');
                    await Swal.fire({
                        icon: 'success',
                        title: 'Registrado',
                        text: 'Paciente registrado exitosamente',
                        timer: 1500,
                        showConfirmButton: false
                    });
                    location.reload();
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo registrar el paciente'
                    });
                }
            } catch(error) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurri√≥ un error al registrar'
                });
            }
        });

        async function borrarPaciente(id) {
            const res = await Swal.fire({
                title: '¬øDar de Baja al Paciente?',
                text: "El paciente ser√° marcado como inactivo pero sus datos permanecer√°n en el sistema.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'S√≠, dar de baja',
                cancelButtonText: 'Cancelar'
            });
            
            if(res.isConfirmed) {
                try {
                    const fd = new FormData();
                    fd.append('pac_id', id);
                    const response = await fetch('/admin/paciente/borrar', { 
                        method: 'POST', 
                        body: fd 
                    });
                    
                    const data = await response.json();
                    
                    if(response.ok) {
                        localStorage.setItem('lastSection', 'pacientes');
                        localStorage.setItem('justSaved', 'true');
                        await Swal.fire({
                            icon: 'success',
                            title: 'Paciente Inactivo',
                            text: 'El paciente ha sido dado de baja del sistema',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        location.reload();
                    } else {
                        await Swal.fire({
                            icon: 'error',
                            title: 'No se pudo dar de baja',
                            text: data.msg || 'Error al dar de baja al paciente'
                        });
                    }
                } catch(error) {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ocurri√≥ un error al intentar eliminar'
                    });
                }
            }
        }

        // --- FUNCIONES DE RESTAURACI√ìN ---
        async function restaurarPaciente(id) {
            const res = await Swal.fire({
                title: '¬øRestaurar Paciente?',
                text: "El paciente volver√° a estar activo en el sistema.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'S√≠, restaurar',
                cancelButtonText: 'Cancelar'
            });
            
            if(res.isConfirmed) {
                try {
                    const fd = new FormData();
                    fd.append('pac_id', id);
                    const response = await fetch('/admin/paciente/restaurar', { 
                        method: 'POST', 
                        body: fd 
                    });
                    
                    if(response.ok) {
                        // Guardar el estado de la secci√≥n actual antes de recargar
                        localStorage.setItem('lastSection', 'pacientes');
                        localStorage.setItem('justRestored', 'true');
                        
                        await Swal.fire({
                            icon: 'success',
                            title: 'Restaurado',
                            text: 'El paciente ha sido restaurado exitosamente',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Recargar la p√°gina
                        location.reload();
                    } else {
                        await Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'No se pudo restaurar el paciente'
                        });
                    }
                } catch(error) {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ocurri√≥ un error al intentar restaurar'
                    });
                }
            }
        }

        async function restaurarDoctor(id) {
            const res = await Swal.fire({
                title: '¬øRestaurar Doctor?',
                text: "El doctor volver√° a estar activo en el sistema.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'S√≠, restaurar',
                cancelButtonText: 'Cancelar'
            });
            
            if(res.isConfirmed) {
                try {
                    const fd = new FormData();
                    fd.append('doc_id', id);
                    const response = await fetch('/admin/doctor/restaurar', { 
                        method: 'POST', 
                        body: fd 
                    });
                    
                    if(response.ok) {
                        // Guardar el estado de la secci√≥n actual antes de recargar
                        localStorage.setItem('lastSection', 'doctores');
                        localStorage.setItem('justRestored', 'true');
                        
                        await Swal.fire({
                            icon: 'success',
                            title: 'Restaurado',
                            text: 'El doctor ha sido restaurado exitosamente',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Recargar la p√°gina
                        location.reload();
                    } else {
                        await Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'No se pudo restaurar el doctor'
                        });
                    }
                } catch(error) {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ocurri√≥ un error al intentar restaurar'
                    });
                }
            }
        }

        async function restaurarCita(id) {
            const res = await Swal.fire({
                title: '¬øRestaurar Cita?',
                text: "La cita volver√° a aparecer en el calendario.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'S√≠, restaurar',
                cancelButtonText: 'Cancelar'
            });
            
            if(res.isConfirmed) {
                try {
                    const fd = new FormData();
                    fd.append('cita_id', id);
                    const response = await fetch('/admin/cita/restaurar', { 
                        method: 'POST', 
                        body: fd 
                    });
                    
                    if(response.ok) {
                        // Guardar el estado de la secci√≥n actual antes de recargar
                        localStorage.setItem('lastSection', 'papelera');
                        localStorage.setItem('justRestored', 'true');
                        
                        await Swal.fire({
                            icon: 'success',
                            title: 'Restaurado',
                            text: 'La cita ha sido restaurada exitosamente',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Recargar la p√°gina
                        location.reload();
                    } else {
                        await Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'No se pudo restaurar la cita'
                        });
                    }
                } catch(error) {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Ocurri√≥ un error al intentar restaurar'
                    });
                }
            }
        }

        // Forzar que el sidebar mantenga su ancho
        function forceKeepSidebar() {
            const sidebar = document.getElementById('sidebar');
            if(sidebar) {
                sidebar.style.width = '16rem';
                sidebar.style.minWidth = '16rem';
                sidebar.style.maxWidth = '16rem';
                sidebar.style.flexShrink = '0';
            }
        }

        // Al cargar la p√°gina, restaurar la √∫ltima secci√≥n visitada y mantener sidebar
        window.addEventListener('DOMContentLoaded', function() {
            // Forzar ancho del sidebar
            forceKeepSidebar();
            
            const lastSection = localStorage.getItem('lastSection');
            const justRestored = localStorage.getItem('justRestored');
            const justSaved = localStorage.getItem('justSaved');
            
            if((justRestored === 'true' || justSaved === 'true') && lastSection) {
                // Limpiar los flags
                localStorage.removeItem('justRestored');
                localStorage.removeItem('justSaved');
                localStorage.removeItem('lastSection');
                
                // Mostrar la secci√≥n guardada
                showSection(lastSection);
            }
            
            // LIMPIAR SIEMPRE los campos de contrase√±a al cargar la p√°gina
            setTimeout(() => {
                const currentPwd = document.getElementById('current_password');
                const newPwd = document.getElementById('new_password');
                const confirmPwd = document.getElementById('confirm_password');
                
                if(currentPwd) {
                    currentPwd.value = '';
                    currentPwd.setAttribute('value', '');
                }
                if(newPwd) {
                    newPwd.value = '';
                    newPwd.setAttribute('value', '');
                }
                if(confirmPwd) {
                    confirmPwd.value = '';
                    confirmPwd.setAttribute('value', '');
                }
            }, 100);
        });

        // Mantener el sidebar fijo despu√©s de cualquier cambio
        window.addEventListener('load', forceKeepSidebar);
        window.addEventListener('resize', forceKeepSidebar);

        // BUSCADOR DE PACIENTES POR CI
        function filtrarPacientes() {
            const searchInput = document.getElementById('searchPaciente').value.trim().toLowerCase();
            const filas = document.querySelectorAll('.fila-paciente');
            let visibles = 0;
            
            filas.forEach(fila => {
                const ci = fila.getAttribute('data-ci').toLowerCase();
                
                if (searchInput === '' || ci.includes(searchInput)) {
                    fila.style.display = '';
                    visibles++;
                } else {
                    fila.style.display = 'none';
                }
            });
            
            // Actualizar contador
            const contador = document.getElementById('resultadoCount');
            if (searchInput !== '') {
                contador.textContent = `${visibles} resultado${visibles !== 1 ? 's' : ''}`;
            } else {
                contador.textContent = '';
            }
        }

        function limpiarBusqueda() {
            document.getElementById('searchPaciente').value = '';
            filtrarPacientes();
        }

        // Validaci√≥n del formulario de perfil/seguridad
        document.getElementById('formPerfil')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            // Ocultar errores previos
            document.getElementById('errorCurrentPassword').classList.add('hidden');
            document.getElementById('errorConfirmPassword').classList.add('hidden');
            
            // VALIDACI√ìN OBLIGATORIA: Contrase√±a actual siempre requerida
            if (!currentPassword || currentPassword.trim() === '') {
                await Swal.fire({
                    icon: 'error',
                    title: 'Contrase√±a Requerida',
                    text: 'Debe ingresar su contrase√±a actual para realizar cambios'
                });
                return;
            }
            
            // Validar que la contrase√±a actual sea correcta
            const actualPassword = "{{ admin.password }}";
            if (currentPassword !== actualPassword) {
                document.getElementById('errorCurrentPassword').classList.remove('hidden');
                await Swal.fire({
                    icon: 'error',
                    title: 'Error de Autenticaci√≥n',
                    text: 'La contrase√±a actual es incorrecta. No se pueden realizar cambios.',
                    confirmButtonColor: '#dc2626'
                });
                return;
            }
            
            // Si se ingres√≥ una nueva contrase√±a, validar
            if (newPassword || confirmPassword) {
                // Validar que ambos campos est√©n llenos
                if (!newPassword || !confirmPassword) {
                    await Swal.fire({
                        icon: 'warning',
                        title: 'Campos Incompletos',
                        text: 'Debe llenar ambos campos de nueva contrase√±a o dejarlos vac√≠os'
                    });
                    return;
                }
                
                // Validar que las nuevas contrase√±as coincidan
                if (newPassword !== confirmPassword) {
                    document.getElementById('errorConfirmPassword').classList.remove('hidden');
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error de Validaci√≥n',
                        text: 'Las contrase√±as nuevas no coinciden'
                    });
                    return;
                }
                
                // Validar longitud m√≠nima
                if (newPassword.length < 4) {
                    await Swal.fire({
                        icon: 'warning',
                        title: 'Contrase√±a D√©bil',
                        text: 'La contrase√±a debe tener al menos 4 caracteres'
                    });
                    return;
                }
            }
            
            // Preparar mensaje de confirmaci√≥n
            let cambios = [];
            const usernameActual = "{{ admin.username }}";
            const newUsername = document.querySelector('[name="username"]').value;
            
            if (newUsername !== usernameActual) {
                cambios.push(`Usuario: <strong>${newUsername}</strong>`);
            }
            
            if (newPassword && newPassword !== actualPassword) {
                cambios.push('Contrase√±a: <strong>Se cambiar√°</strong>');
            }
            
            if (cambios.length === 0) {
                await Swal.fire({
                    icon: 'info',
                    title: 'Sin Cambios',
                    text: 'No se detectaron cambios en las credenciales'
                });
                return;
            }
            
            // Confirmar cambio
            const result = await Swal.fire({
                icon: 'question',
                title: '¬øConfirmar Cambios?',
                html: `<p class="text-sm mb-3">Est√° a punto de actualizar:</p>
                       <div class="text-left bg-slate-50 p-3 rounded">
                           ${cambios.map(c => `<p class="text-sm">‚Ä¢ ${c}</p>`).join('')}
                       </div>`,
                showCancelButton: true,
                confirmButtonText: 'S√≠, actualizar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#059669',
                cancelButtonColor: '#6b7280'
            });
            
            if (result.isConfirmed) {
                // Enviar formulario
                this.submit();
            }
        });

        // Cerrar modales con ESC
        document.addEventListener('keydown', function(e) {
            if(e.key === 'Escape') {
                cerrarModalDoctor();
                cerrarModalPaciente();
                cerrarModalDetallePaciente();
            }
        });
    </script>
</body>
</html>