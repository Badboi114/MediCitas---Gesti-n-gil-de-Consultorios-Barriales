<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCitas | Agenda Clínica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        .fc-toolbar-title > div { display: inline-block !important; }
        .fc-button { text-transform: capitalize !important; font-weight: 600 !important; }
        .fc-button-primary { background-color: #10b981 !important; border-color: #059669 !important; }
        .fc-timegrid-slot { height: 3.5em !important; }
        .fc-event { cursor: pointer; border: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Animación suave para el modal */
        #modalContainer { transition: max-width 0.4s ease-in-out; }
        #panelHistorial { transition: opacity 0.3s ease-in, transform 0.3s; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <nav class="bg-white shadow-sm border-b border-slate-200 px-6 py-3 flex justify-between items-center z-20">
        <div class="text-xl font-bold text-slate-700 flex items-center gap-2">
            <span class="bg-emerald-500 text-white rounded p-1 text-sm">MC</span> Medi<span class="text-emerald-600">Citas</span>
        </div>
        
        {% if es_admin %}
        <a href="/admin" class="bg-slate-800 text-white text-xs px-4 py-2 rounded-full font-bold hover:bg-slate-700 transition shadow-lg flex items-center gap-2">
            Volver al Panel Admin
        </a>
        {% else %}
        <a href="/" class="text-xs text-slate-400 hover:text-emerald-600">Volver al Inicio</a>
        {% endif %}
    </nav>

    <div class="flex flex-col md:flex-row h-[calc(100vh-60px)]">
        <div class="w-full md:w-72 bg-white border-r border-slate-200 p-5 flex flex-col gap-6 shadow-lg">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Especialista</label>
                <select id="doctorSelect" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none">
                    <option value="" disabled selected>Seleccione Doctor...</option>
                    {% for doctor in doctores %}
                    <option value="{{ doctor.id }}" 
                            data-duracion="{{ doctor.duracion_cita }}"
                            data-entrada="{{ doctor.hora_entrada if doctor.hora_entrada else config.hora_apertura }}"
                            data-salida="{{ doctor.hora_salida if doctor.hora_salida else config.hora_cierre }}">
                        {{ doctor.nombre }} ({{ doctor.especialidad }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div id="infoHorario" class="hidden bg-blue-50 p-3 rounded-lg text-xs text-blue-800 border border-blue-100">
                <p class="font-bold">Horario de Atención:</p>
                <p><span id="spanEntrada"></span> - <span id="spanSalida"></span></p>
            </div>
            <div class="mt-auto bg-slate-50 p-3 rounded-lg border border-slate-100">
                <p class="text-[10px] text-slate-400 font-bold mb-2 uppercase">Ayuda:</p>
                <ul class="text-[11px] text-slate-500 list-disc pl-4">
                    <li>Escribe el CI para buscar.</li>
                    <li>Si ya existe, los datos se cargan solos.</li>
                </ul>
            </div>
        </div>
        <div class="flex-grow bg-white p-2 md:p-4 overflow-hidden relative">
            <div id="calendar" class="h-full w-full"></div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-50 backdrop-blur-sm transition-opacity p-4">
        
        <div id="modalContainer" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 border border-slate-100 transform transition-all scale-100 max-h-[95vh] overflow-y-auto">
            
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        Gestión de Cita
                    </h2>
                    <p class="text-xs text-emerald-600 font-medium mt-1 capitalize" id="modalFechaTitulo">Fecha</p>
                </div>
                <button onclick="cerrarModal()" class="text-slate-400 hover:text-red-500 text-2xl leading-none">&times;</button>
            </div>

            <form id="formCita" class="flex flex-col md:flex-row gap-8">
                
                <div class="flex-1 space-y-4">
                    <input type="hidden" id="citaId">

                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 flex gap-3">
                        <div class="w-1/2">
                            <label class="text-[10px] text-slate-400 block font-bold">INICIO</label>
                            <input type="time" id="horaInicioInput" step="60" class="w-full p-1.5 bg-white border rounded font-mono font-bold outline-none focus:ring-1 focus:ring-emerald-500">
                        </div>
                        <div class="w-1/2">
                            <label class="text-[10px] text-slate-400 block font-bold">FIN</label>
                            <input type="time" id="horaFinInput" class="w-full p-1.5 bg-white border rounded font-mono outline-none focus:ring-1 focus:ring-emerald-500">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="relative">
                            <label class="text-xs font-bold text-slate-500">Cédula Identidad (Busca auto.)</label>
                            <input type="number" id="ci" class="w-full bg-slate-50 border-b-2 p-2 outline-none focus:border-emerald-500 transition-colors" required placeholder="Ingrese CI...">
                            <span id="msgUsuarioEncontrado" class="hidden absolute right-0 top-6 text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold">Encontrado</span>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-500">Nombre Completo</label>
                            <input type="text" id="nombre" class="w-full bg-slate-50 border-b-2 p-2 outline-none focus:border-emerald-500 transition-colors" required>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-500">Celular</label>
                            <div class="relative">
                                <span class="absolute left-2 top-2 text-slate-400 text-sm">+591</span>
                                <input type="number" id="telefono" class="w-full bg-slate-50 border-b-2 p-2 pl-12 outline-none focus:border-emerald-500 transition-colors" required>
                            </div>
                        </div>
                    </div>

                    <button type="button" onclick="toggleHistorialSide()" id="btnToggleHistorial" class="w-full py-2 px-3 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold flex justify-between items-center hover:bg-blue-100 transition-colors border border-blue-100">
                        <span>Ver Expediente / Historial Médico</span>
                        <span>»</span>
                    </button>

                    <div>
                        <label class="text-xs font-bold text-slate-500">Motivo de Consulta</label>
                        <textarea id="motivo" class="w-full bg-slate-50 border rounded-lg p-2 outline-none h-20 resize-none focus:ring-1 focus:ring-emerald-500" placeholder="Razón de la visita..."></textarea>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="button" onclick="cerrarModal()" class="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-200">Cancelar</button>
                        <button type="submit" id="btnGuardar" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg text-sm font-bold hover:bg-emerald-600 shadow-md">Guardar</button>
                        <button type="button" id="btnEditar" onclick="activarEdicion()" class="hidden flex-1 bg-blue-500 text-white rounded-lg text-sm font-bold shadow-md">Editar</button>
                        <button type="button" id="btnEliminar" onclick="eliminarCita()" class="hidden flex-1 bg-red-500 text-white rounded-lg text-sm font-bold shadow-md">Borrar</button>
                    </div>
                </div>

                <div id="panelHistorial" class="hidden w-full md:w-80 border-l-2 border-dashed border-slate-200 pl-0 md:pl-8 flex flex-col gap-4 bg-slate-50/50 rounded-r-xl">
                    <div class="flex items-center gap-2 text-emerald-700 border-b pb-2 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
                        <h3 class="font-bold text-sm">Expediente Clínico</h3>
                    </div>

                    <div class="space-y-4 text-sm">
                        <div>
                            <label class="block text-[10px] font-bold text-red-500 uppercase mb-1">Alergias</label>
                            <input type="text" id="alergias" class="w-full p-2 border border-red-100 bg-red-50 rounded text-slate-700 focus:border-red-300 outline-none" placeholder="Ninguna conocida">
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-bold text-blue-500 uppercase mb-1">Cirugías Previas</label>
                            <input type="text" id="cirugias" class="w-full p-2 border border-blue-100 bg-blue-50 rounded text-slate-700 focus:border-blue-300 outline-none" placeholder="Ninguna">
                        </div>

                        <div class="flex-grow flex flex-col">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Notas Médicas / Antecedentes</label>
                            <textarea id="notas" class="w-full flex-grow p-3 border border-slate-200 bg-white rounded text-slate-600 focus:border-emerald-300 outline-none resize-none min-h-[150px]" placeholder="Escriba aquí antecedentes importantes, medicación actual, etc..."></textarea>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <script>
        let calendar;
        const modal = document.getElementById('modal');
        const modalContainer = document.getElementById('modalContainer');
        const panelHistorial = document.getElementById('panelHistorial');
        const doctorSelect = document.getElementById('doctorSelect');
        const modalFechaTitulo = document.getElementById('modalFechaTitulo');
        const horaInicioInput = document.getElementById('horaInicioInput');
        const horaFinInput = document.getElementById('horaFinInput');
        let duracionDoctor = 30;
        let fechaActualDia = new Date();

        // --- LÓGICA DE EXPANSIÓN LATERAL ---
        function toggleHistorialSide(forceOpen = false) {
            const isHidden = panelHistorial.classList.contains('hidden');
            const btn = document.getElementById('btnToggleHistorial');

            if (isHidden || forceOpen) {
                // ABRIR (Expandir a la derecha)
                modalContainer.classList.remove('max-w-lg');
                modalContainer.classList.add('max-w-5xl'); // Ancho grande
                
                panelHistorial.classList.remove('hidden');
                
                btn.innerHTML = `<span>« Ocultar Expediente</span> <span>«</span>`;
                btn.classList.replace('bg-blue-50', 'bg-slate-100');
                btn.classList.replace('text-blue-600', 'text-slate-600');
            } else {
                // CERRAR (Volver a normal)
                panelHistorial.classList.add('hidden');
                
                modalContainer.classList.remove('max-w-5xl');
                modalContainer.classList.add('max-w-lg'); // Ancho normal
                
                btn.innerHTML = `<span>Ver Expediente / Historial Médico</span> <span>»</span>`;
                btn.classList.replace('bg-slate-100', 'bg-blue-50');
                btn.classList.replace('text-slate-600', 'text-blue-600');
            }
        }

        // --- BÚSQUEDA PACIENTE ---
        document.getElementById('ci').addEventListener('blur', async function() {
            const ci = this.value;
            if(ci.length > 4) {
                const res = await fetch(`/api/paciente/${ci}`);
                const data = await res.json();
                
                const msg = document.getElementById('msgUsuarioEncontrado');
                if(data.encontrado) {
                    msg.classList.remove('hidden');
                    document.getElementById('nombre').value = data.nombre;
                    document.getElementById('telefono').value = data.telefono;
                    document.getElementById('alergias').value = data.alergias;
                    document.getElementById('cirugias').value = data.cirugias;
                    document.getElementById('notas').value = data.notas;
                    
                    // Si tiene historial relevante, abrir automáticamente el panel lateral
                    if(data.alergias || data.notas) {
                        toggleHistorialSide(true);
                    }
                    
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Paciente encontrado', showConfirmButton: false, timer: 2000 });
                } else {
                    msg.classList.add('hidden');
                }
            }
        });

        // --- GESTIÓN DE MODOS ---
        function resetearFormulario(modo) {
            const form = document.getElementById('formCita');
            const inputs = form.querySelectorAll('input:not([type=hidden]), textarea');
            document.getElementById('msgUsuarioEncontrado').classList.add('hidden');
            
            // Siempre resetear al estado "cerrado" (angosto)
            panelHistorial.classList.add('hidden');
            modalContainer.classList.remove('max-w-5xl');
            modalContainer.classList.add('max-w-lg');
            const btn = document.getElementById('btnToggleHistorial');
            btn.innerHTML = `<span>Ver Expediente / Historial Médico</span> <span>»</span>`;

            if (modo === 'nuevo') {
                document.getElementById('citaId').value = '';
                form.reset();
                inputs.forEach(i => i.disabled = false);
                document.getElementById('btnGuardar').classList.remove('hidden');
                document.getElementById('btnEditar').classList.add('hidden');
                document.getElementById('btnEliminar').classList.add('hidden');
            } else { // Ver
                inputs.forEach(i => i.disabled = true);
                document.getElementById('btnGuardar').classList.add('hidden');
                document.getElementById('btnEditar').classList.remove('hidden');
                document.getElementById('btnEliminar').classList.remove('hidden');
                
                // Habilitar botón de historial aunque esté en modo lectura para poder verlo
                document.getElementById('btnToggleHistorial').disabled = false;
            }
        }

        window.activarEdicion = function() {
            document.querySelectorAll('#formCita input, #formCita textarea').forEach(i => i.disabled = false);
            document.getElementById('btnEditar').classList.add('hidden');
            document.getElementById('btnEliminar').classList.add('hidden');
            document.getElementById('btnGuardar').classList.remove('hidden');
        }

        window.eliminarCita = async function() {
            const id = document.getElementById('citaId').value;
            const res = await Swal.fire({ title: '¿Borrar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Sí' });
            if (res.isConfirmed) {
                const fd = new FormData(); fd.append('cita_id', id);
                await fetch('/borrar', { method: 'POST', body: fd });
                cerrarModal(); doctorSelect.dispatchEvent(new Event('change'));
                Swal.fire('Borrado', '', 'success');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            
            // CONFIGURACIÓN DE DÍAS (Convertimos string "1,2,3" a array [1,2,3])
            const diasLaboralesStr = "{{ config.dias_laborales }}";
            const diasLaborales = diasLaboralesStr.split(',').map(Number);
            const allDays = [0, 1, 2, 3, 4, 5, 6];
            const hiddenDays = allDays.filter(d => !diasLaborales.includes(d));
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es', initialView: 'dayGridMonth', 
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek,timeGridDay' },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'Día'
                },
                
                // CONFIGURACIÓN DINÁMICA
                hiddenDays: hiddenDays, // Oculta días no laborales globalmente
                slotMinTime: '{{ config.hora_apertura }}:00', 
                slotMaxTime: '{{ config.hora_cierre }}:00',
                
                allDaySlot: false, slotDuration: '00:15:00',
                slotLabelContent: function(arg) { return { html: `<span class="text-xs font-mono text-slate-500">${arg.text}</span>` }; },
                slotLabelFormat: { hour: '2-digit', minute: '2-digit', omitZeroMinute: false, meridiem: false, hour12: false },
                dayHeaderContent: function(arg) {
                    let t = arg.date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'numeric' });
                    return { html: `<span class="capitalize text-slate-700 font-semibold">${t.replace('.', '')}</span>` };
                },
                datesSet: function() {
                    const tEl = document.querySelector('.fc-toolbar-title');
                    if(tEl) {
                        const f = calendar.getDate();
                        const m = f.toLocaleString('es-ES', { month: 'long' });
                        tEl.innerText = `${m.charAt(0).toUpperCase() + m.slice(1)} de ${f.getFullYear()}`;
                    }
                },
                selectable: true, navLinks: false,
                dateClick: function(info) {
                    if (info.view.type !== 'timeGridDay') { calendar.changeView('timeGridDay', info.dateStr); fechaActualDia = info.date; }
                    else { if(!doctorSelect.value) return Swal.fire('Error', 'Seleccione Doctor', 'warning'); abrirModalNuevo(info.date); }
                },
                select: function(info) {
                    if(info.view.type === 'timeGridDay') {
                         if(!doctorSelect.value) return Swal.fire('Error', 'Seleccione Doctor', 'warning');
                         abrirModalNuevo(info.start);
                    }
                },
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    resetearFormulario('ver');
                    document.getElementById('citaId').value = props.cita_id;
                    document.getElementById('ci').value = props.ci;
                    document.getElementById('nombre').value = props.nombre;
                    document.getElementById('telefono').value = props.telefono;
                    document.getElementById('motivo').value = props.motivo;
                    document.getElementById('alergias').value = props.alergias || '';
                    document.getElementById('cirugias').value = props.cirugias || '';
                    document.getElementById('notas').value = props.notas || '';
                    
                    const start = info.event.start;
                    const end = info.event.end || start;
                    document.getElementById('horaInicioInput').value = start.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit', hour12:false});
                    document.getElementById('horaFinInput').value = end.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit', hour12:false});
                    
                    fechaActualDia = start;
                    modal.classList.remove('hidden');
                }
            });
            calendar.render();
        });

        // CAMBIO DE DOCTOR (Lógica Horarios Personalizados)
        doctorSelect.addEventListener('change', async (e) => {
            const docId = e.target.value;
            const option = e.target.options[e.target.selectedIndex];
            
            // Leer datos del option
            duracionDoctor = parseInt(option.getAttribute('data-duracion'));
            const horaEntrada = option.getAttribute('data-entrada');
            const horaSalida = option.getAttribute('data-salida');

            // Actualizar calendario visualmente
            calendar.setOption('slotMinTime', horaEntrada + ':00');
            calendar.setOption('slotMaxTime', horaSalida + ':00');
            
            // Mostrar info
            document.getElementById('infoHorario').classList.remove('hidden');
            document.getElementById('spanEntrada').innerText = horaEntrada;
            document.getElementById('spanSalida').innerText = horaSalida;

            // Recargar citas
            calendar.getEventSources().forEach(src => src.remove());
            const res = await fetch(`/api/citas/${docId}`);
            const ev = await res.json();
            calendar.addEventSource(ev);
        });

        function abrirModalNuevo(fechaDate) {
            resetearFormulario('nuevo');
            fechaActualDia = fechaDate;
            const h = String(fechaDate.getHours()).padStart(2, '0');
            const m = String(fechaDate.getMinutes()).padStart(2, '0');
            horaInicioInput.value = `${h}:${m}`;
            actualizarHoraFin();
            const op = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('modalFechaTitulo').innerText = fechaDate.toLocaleDateString('es-ES', op);
            modal.classList.remove('hidden');
        }

        horaInicioInput.addEventListener('change', actualizarHoraFin);
        function actualizarHoraFin() {
            if(!horaInicioInput.value) return;
            const [h, m] = horaInicioInput.value.split(':').map(Number);
            const fin = new Date(); fin.setHours(h); fin.setMinutes(m + duracionDoctor);
            horaFinInput.value = `${String(fin.getHours()).padStart(2,'0')}:${String(fin.getMinutes()).padStart(2,'0')}`;
        }

        document.getElementById('formCita').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Validaciones Regex (igual que antes)
            if (!/^\d{5,12}$/.test(document.getElementById('ci').value)) return Swal.fire('Error CI', 'CI inválido', 'warning');
            if (!/^[67]\d{7}$/.test(document.getElementById('telefono').value)) return Swal.fire('Error Celular', 'Celular inválido', 'warning');

            // COPIAR motivo de consulta a notas médicas antes de guardar
            const motivoConsulta = document.getElementById('motivo').value;
            const notasActuales = document.getElementById('notas').value;
            
            // Si hay motivo y las notas están vacías o no contienen el motivo, agregarlo
            if (motivoConsulta && motivoConsulta.trim()) {
                const fechaActual = new Date().toLocaleDateString('es-ES');
                const nuevaNota = `[${fechaActual}] Motivo de consulta: ${motivoConsulta}`;
                
                if (notasActuales && notasActuales.trim()) {
                    // Si ya hay notas, agregar el motivo al final
                    document.getElementById('notas').value = notasActuales + '\n\n' + nuevaNota;
                } else {
                    // Si no hay notas, simplemente poner el motivo
                    document.getElementById('notas').value = nuevaNota;
                }
            }

            const fIso = `${fechaActualDia.toISOString().split('T')[0]}`;
            const fd = new FormData();
            fd.append('cita_id', document.getElementById('citaId').value);
            fd.append('doctor_id', doctorSelect.value);
            fd.append('fecha_inicio_str', `${fIso}T${horaInicioInput.value}:00`);
            fd.append('fecha_fin_str', `${fIso}T${horaFinInput.value}:00`);
            fd.append('paciente_ci', document.getElementById('ci').value);
            fd.append('paciente_nombre', document.getElementById('nombre').value);
            fd.append('paciente_telefono', document.getElementById('telefono').value);
            fd.append('motivo', document.getElementById('motivo').value);
            // Historial
            fd.append('paciente_alergias', document.getElementById('alergias').value);
            fd.append('paciente_cirugias', document.getElementById('cirugias').value);
            fd.append('paciente_notas', document.getElementById('notas').value);

            try {
                const res = await fetch('/agendar', { method: 'POST', body: fd });
                const data = await res.json();
                if(res.ok) {
                    cerrarModal();
                    Swal.fire({ icon: 'success', title: 'Guardado', showConfirmButton: false, timer: 1500 });
                    doctorSelect.dispatchEvent(new Event('change'));
                } else { Swal.fire('Error', data.msg, 'error'); }
            } catch(e) { Swal.fire('Error', 'Fallo conexión', 'error'); }
        });

        window.cerrarModal = function() {
            modal.classList.add('hidden');
            document.getElementById('formCita').reset();
        }
    </script>
</body>
</html>
